# gRPC PubSub Service

Сервис публикации/подписки событий по ключу на основе gRPC и встроенного in‑memory движка pubsub.

## Описание

Сервис предоставляет два метода:

- **Subscribe** (server‑streaming): клиент передаёт ключ, получает поток событий `Event { data }`.
- **Publish** (unary): клиент отправляет ключ и данные, сервис рассылает их всем активным подписчикам.

Все события доставляются в порядке FIFO; медленные подписчики не блокируют быстрых. При остановке сервиса (`SIGINT`/`SIGTERM`) происходит graceful shutdown: новые запросы отвергаются, текущие публикации дожидаются контекста, затем соединения закрываются.

## Конфигурация
Пример файла конфигурации находится в корне проекта и называется config.example.yaml:
```text
grpc:
  host: 0.0.0.0 # IP адрес для прослушивания
  port: 50051 # Порт для прослушивания

logger:
  level: debug # Уровень логирования (debug, info, warn, error)
  format: console # Формат логов (console, json)
  
graceful_shutdown_timeout: 10s # Таймаут для graceful shutdown
```

## Сборка и запуск
### Локально
Убедите, что у вас установлен Go версии 1.23 или выше. Затем выполните следующие команды:
1. Создайте файл конфигурации:
   ```bash
   cp config.example.yaml config.yaml
   ```
   Настройте параметры в `config.yaml` по вашему усмотрению.
2. Соберите проект:
   ```bash
   go build -o bin/server ./cmd/main.go
   ```
   
3. Запустите сервер:
   ```bash
   ./bin/server
   ```
   Если файл конфигурации лежит не в корне проекта, вызовите сервер с флагом `config`:
   ```bash
    ./bin/server --config /path/to/config.yaml
    ```
   
### Docker
1. Создайте файл конфигурации:
   ```bash
   cp config.example.yaml config.yaml
   ```
   Настройте параметры в `config.yaml` по вашему усмотрению.
2. Соберите образ:
   ```bash
   docker build -t grpc-pubsub .
   ```
3. Запустите контейнер:
   ```bash
    docker run grpc-pubsub
    ```
При сборке в Docker используется файл конфигурации `config.yaml`, который должен находиться в корне проекта.
   
## Best Practices
### Graceful Shutdown
Сервис поддерживает graceful shutdown. При получении сигнала `SIGINT` или `SIGTERM` он завершает текущие запросы и закрывает соединения. Это позволяет избежать потери данных и гарантирует, что все подписчики получат последние события.
Если активные подписчики не отписались, сервис завершит работу через таймаут, указанный в конфигурации `graceful_shutdown_timeout`.

### DI, Dependency Injection
В качестве простого DI используется явная передача зависимостей при создании компонентов. 
Это позволяет легко заменять реализации интерфейсов, что полезно для тестирования и расширения функциональности.

Пример:
```go
pubSub := subpub.NewSubPub()
appLogger, err := logger.NewLogger(appConfig.Logger.Level, appConfig.Logger.Format)
pubSubServer := server.NewPubSubServer(appLogger, pubSub)
```
Таким образом, grpcServer не создает зависимости внутри себя, а получает их извне, что делает поведение сервиса более предсказуемым и гибким.

### Логирование
Логирование реализовано с помощью библиотеки `zap`. Уровень логирования и формат можно настроить в конфигурационном файле.

